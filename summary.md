# NumaNavi (沼ナビ) - アプリケーション仕様書 (現状版)

**最終更新:** 2026-01-26

## 1. プロジェクト概要
**コンセプト:** 「AI紳士オタク」が、ユーザーの性癖を分析し、現在のアニメ・マンガ・ラノベの海（沼）へといざなうレコメンデーションサービス。
**コアバリュー:** 検索ではなく「巡り会い」。データマッチングと感情的なプレゼンテーションの融合。

## 2. コア機能

### 2.1 診断 (Quiz)
- **フロー:** 7-8問の選択式 (アニメ/漫画の選択 -> 雰囲気 -> NG要素 -> ストーリー重視度 -> 余韻の好み -> 沼り度合い)。
- **ロジック:** ユーザーの回答を「意味論的プロファイル (Semantic Profile)」に変換し、データベース検索のクエリとして使用。

### 2.2 AIレコメンデーション (Discovery Pipeline)
- **紳士的オタク (Gentleman Otaku):** AIエージェントの人格。丁寧かつ情熱的な敬語（デス・マス調）で語る。
- **2段階フィルタリング:**
    1.  **DB検索 (Candidate Selection):** タグ重み付きアルゴリズム (`weighted_genres`, `canonical_tags`) で数百件の候補から上位を抽出。
    2.  **AIランク付け (AI Ranking):** Gemini Flash 2.5 を使用し、候補作品を「ユーザープロファイル」と照らし合わせてスコアリング。
        - **ショットガン戦略:** 「王道」「意外性」「深淵（Deep）」の3方向から提案。
- **出力:** 推奨理由（Reason）とスコア（Numa Score）を動的に生成。

### 2.3 沼への潜行 (Pivot Pipeline - "Swamp Expansion")
- **目的:** 気に入った作品の方向性で、さらに深く掘り下げる（芋づる式検索）。
- **最適化 (Swamp Expansion):**
    - **高速化:** 従来のフルスキャン（~16秒）を廃止し、アイテム間類似度（Item-to-Item Similarity）ベースの検索に変更（<4秒）。
    - **ロジック:** 起点となる作品の「成分（タグ・ジャンル）」と類似度が70%以上の作品をDBから高速取得し、AIが少数（3〜5件）のみを即座に「継承者」としてプレゼン。
    - **UX:** 「沼への潜行中...」という没入感のあるロード演出。

### 2.4 ユーザーインターフェース (UI)
- **デザイン:** ダークモード基調、グラデーション（Pink/Purple）を用いた「沼」の表現。
- **メインアクション:**
    - **「これにNumaる」:** 公式リンクを別タブで開き、作品へ直行する。
    - **「この方向性で他をNumaる」:** Pivot機能を発動。
- **詳細表示:** サムネイルクリックで、AIが翻訳した日本語あらすじと詳細メタデータを表示。

## 3. 技術スタック & アーキテクチャ

### Frontend / Framework
- **Next.js 14+ (App Router):** Server Actions を活用したセキュアなAI呼び出し。
- **Tailwind CSS:** 独自のデザインシステム（Numa Design System）を構築。
- **Framer Motion:** マイクロインタラクションとページ遷移アニメーション。

### Backend / Data
- **Supabase (PostgreSQL):**
    - `works` テーブル: 作品メタデータ、タグ、ベクトル（将来用）。
    - `weighted_genres`: タグの重要度を数値化したJSONカラム。
- **Data Ingestion:** AniList GraphQL API からデータを取り込み・正規化。

### AI & Agents
- **Google Gemini 2.5 Flash:** メインの推論エンジン。高速かつ安価。
- **OpenAI (Note):** インターフェース (`NIAIProvider`) は用意されているが、現在はGeminiがデフォルト。
- **Prompt Engineering:** 「紳士的オタク」ペルソナを一貫させるための厳格なプロンプト設計。

## 4. データ状況
- **ソース:** AniList
- **現在の件数:** 約800件 (アニメ: ~400, マンガ: ~200, ラノベ: ~200)
- **品質:** 英語メタデータが主だが、AIパイプラインで動的に日本語化（あらすじ翻訳機能済み）。

## 5. パフォーマンス目標 (現状)
- **初回レコメンド:** 8〜12秒 (許容範囲: "診断中"の演出でカバー)
- **Pivot (深掘り):** <4秒 (達成済み)
- **UIレスポンス:** 即時 (Optimistic UI)

## 6. 今後の課題・ロードマップ
1.  **データ拡充:** 800件 -> 5000件規模へのスケール。
2.  **SNSシェア:** 「この沼に落ちました」画像の生成・シェア機能。
3.  **ユーザーアカウント:** 履歴の保存と個人の「沼マップ」作成。
