# NumaNavi 製品仕様書 (v1.0)

## 1. プロダクト概要
NumaNavi（沼ナビ）は、ユーザーの潜在的な好みや今の気分を分析し、膨大な作品データからその人を「沼」に引き込む最適な作品（アニメ、漫画、ライトノベル）をレコメンドする診断アプリケーションです。

### 1.1 コンセプト
「今の自分に刺さる作品が、必ず見つかる」。直感的なUIとAIによる情緒的な分析を組み合わせ、従来のジャンル検索では辿り着けない「刺さる1本」を提案します。

---

## 2. 技術スタック
- **Frontend**: Next.js (App Router), TypeScript, Tailwind CSS, Framer Motion
- **Backend/Database**: Supabase (PostgreSQL)
- **AI/LLM**: Google Gemini 1.5 Flash / OpenAI GPT-4o-mini
- **Visuals**: CSS-based dynamic gradient engine, Lucide React (Icons)
- **Utilities**: `html-to-image` (結果画像生成), `AniList API` (データ提供元)

---

## 3. 主要機能とコアロジック

### 3.1 診断システム (2段階式)
合計9問の設問を通じ、ユーザーの感性を多角的に分析します。

#### 第1段階：基幹診断 (Q0〜Q6)
1. **Q0 媒体選択**: アニメ、漫画、ラノベ、またはそれらの混在を選択。
2. **Q1 深度 (オタク度)**: ライト（定番）〜ディープ（癖強）まで。
3. **Q2 刺激レベル (Attack Level)**: 
   - 年齢ゲート（18歳以上/未満）と連動。
   - 18歳未満には「成人向け」選択肢を表示せず、検索からもR18作品を除外。
4. **Q3 刺さる方向 (Core Desire)**: 物語、熱量、関係性のいずれを優先するか。
5. **Q4 後味 (Sentiment)**: 爽快、余韻、闇。
6. **Q5 コミットメント (Volume)**: 視聴・読了にかかる時間の許容範囲。
7. **Q6 媒体別こだわり**: 選んだ媒体に応じた技術的なこだわり（作画、脚本、密度など）。

#### 第2段階：ディープ・ダイブ (Q7〜Q8 / 任意)
初回結果表示後に「さらに精度を高める」場合に発動。
8. **Q7 世界の手触り (Reality)**: 設定の現実感（現実寄り〜非現実寄り）。
9. **Q8 キャラの駆動力 (Drive)**: キャラクターが動く根源的な理由（善性、業、カオス）。

---

### 3.2 2段階レコメンドエンジン
#### Phase 1: データベース・フィルタリング (Supabase)
DBクエリにより、高速に候補を 100〜150件 選別。
- **ハード・フィルタ**: Q0(媒体), Q2(刺激レベル) による厳格な除外。
- **ヒューリスティック・スコアリング**: Q1, Q3, Q4, Q5 の回答を重み付けして合算。

#### Phase 2: AIによる情緒ランキング (AI Agent)
選別された候補リストと、ユーザーの「回答から生成された自然言語プロファイル」をAIに渡し、情緒的な整合性で最終順位（Top 3）を決定。
- **日本語化**: オリジナルの説明文が英語の場合、AIがその場で情緒豊かな日本語に翻訳・要約。
- **多様性の担保**: リピートユーザー向けに、履歴を考慮してTop 1を入れ替えるよう指示。

---

### 3.3 セーフティ・ガードライツ
- **年齢確認ゲート**: 18歳未満のアクセス時に制限を適用。
- **R18/R15 判定基準**: 
  - R18: 性的描写（Nudity）、過激な残虐描写（Gore）を含む。サムネイルを強制ぼかし。
  - R15: ホラー、サイコパス、お色気（Ecchi）、激しい暴力。
- **動的フィルタリング**: ユーザーが低刺激を希望した場合、DBクエリレベルでの即時除外。

---

## 4. UI/UX 特徴
- **プレミアム背景エンジン**: 回答に合わせて背景のHSL値が動的に遷移し、診断への没入感を高める。
- **Best Match ポップアップ**: 最も刺さると判定された作品をドラマチックな全面ポップアップで紹介。
- **Numa Type (二つ名)**: AIがユーザーの沼属性をキャッチーに命名（例：静謐なるSFの探究者）。
- **シェア・画像保存**: 判定結果を画像として保存、またはハッシュタグ付きで X (旧Twitter) へ投稿可能。

---

## 5. データ構造

### 5.1 Work オブジェクト (作品データ)
```typescript
interface Work {
  id: string;
  title: string;
  media: 'anime' | 'manga' | 'lightnovel';
  rating: 'G' | 'R15' | 'R18';
  description: string;
  thumbnailUrl: string;
  tags: {
    depth: number;      // 0-2
    intensity: number;  // 0-2
    commitment: number; // 0-2 (ボリューム感)
    direction: string;
    aftertaste: string;
  };
  genres: string[];     // AniList の Genres および Rank 80%以上の Tags を統合
  weighted_genres: { name: string; value: number }[]; // AniList Tag Rank (0-100) を保持
}
```

---

## 6. 今後の展望
- **ユーザー認証**: お気に入り作品の保存機能。
- **作品データの拡充**: 2010年代以降の最新作、特定のマイナージャンルの専門データの追加。
- **ソーシャル・リレーション**: 同じ「沼」を持つユーザー同士の緩やかな繋がり。
